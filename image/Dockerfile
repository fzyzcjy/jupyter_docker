FROM cschranz/gpu-jupyter:v1.6_cuda-12.0_ubuntu-22.04

USER root

# copied and modified from https://github.com/rust-lang/docker-rust/blob/52210a27e61827edc257687d4b7cad1fd71d6f6f/1.76.0/buster/Dockerfile
ENV RUSTUP_HOME=/usr/local/rustup \
    CARGO_HOME=/usr/local/cargo \
    PATH=/usr/local/cargo/bin:$PATH \
    RUST_VERSION=1.76.0
RUN set -eux; \
    dpkgArch="$(dpkg --print-architecture)"; \
    case "${dpkgArch##*-}" in \
        amd64) rustArch='x86_64-unknown-linux-gnu'; rustupSha256='a3d541a5484c8fa2f1c21478a6f6c505a778d473c21d60a18a4df5185d320ef8' ;; \
        armhf) rustArch='armv7-unknown-linux-gnueabihf'; rustupSha256='7cff34808434a28d5a697593cd7a46cefdf59c4670021debccd4c86afde0ff76' ;; \
        arm64) rustArch='aarch64-unknown-linux-gnu'; rustupSha256='76cd420cb8a82e540025c5f97bda3c65ceb0b0661d5843e6ef177479813b0367' ;; \
        i386) rustArch='i686-unknown-linux-gnu'; rustupSha256='cacdd10eb5ec58498cd95dbb7191fdab5fa4343e05daaf0fb7cdcae63be0a272' ;; \
        *) echo >&2 "unsupported architecture: ${dpkgArch}"; exit 1 ;; \
    esac; \
    url="https://static.rust-lang.org/rustup/archive/1.27.0/${rustArch}/rustup-init"; \
    wget "$url"; \
    echo "${rustupSha256} *rustup-init" | sha256sum -c -; \
    chmod +x rustup-init; \
    ./rustup-init -y --no-modify-path --profile default --default-toolchain $RUST_VERSION --default-host ${rustArch}; \
    rm rustup-init; \
    chmod -R a+w $RUSTUP_HOME $CARGO_HOME; \
    rustup --version; \
    cargo --version; \
    rustc --version;

# copied and modified from https://github.com/xubaiw/docker-lean/blob/main/Dockerfile
ENV ELAN_HOME=/usr/local/elan \
    PATH=/usr/local/elan/bin:$PATH \
    LEAN_VERSION=leanprover/lean4:4.6.1
RUN set -eux; \
    wget https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh; \
    chmod +x elan-init.sh; \
    ./elan-init.sh -y --no-modify-path --default-toolchain $LEAN_VERSION; \
    chmod -R a+w $ELAN_HOME; \
    elan --version; \
    lean --version; \
    leanc --version; \
    lake --version; \

USER ${NB_UID}

# https://jupyter-docker-stacks.readthedocs.io/en/latest/using/faq.html#how-to-persist-user-data
# some steps are required by https://github.com/jupyter-lsp/jupyterlab-lsp
# https://jupyter-docker-stacks.readthedocs.io/en/latest/using/recipes.html#using-mamba-install-recommended-or-pip-install-in-a-child-docker-image
COPY --chown=${NB_UID}:${NB_GID} requirements.txt /tmp/
RUN \
    pip install --no-cache-dir --requirement /tmp/requirements.txt && \
    fix-permissions "${CONDA_DIR}" && \
    fix-permissions "/home/${NB_USER}"

RUN \
    jupyter labextension disable "@jupyterlab/apputils-extension:announcements" && \
    ln -s / /home/jovyan/.lsp_symlink && \
    printf '\n\nc.ContentsManager.allow_hidden=True\n\n' >> /etc/jupyter/jupyter_server_config.py
